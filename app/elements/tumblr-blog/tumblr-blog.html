<link rel="import" href="../../bower_components/byutv-jsonp/byutv-jsonp.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="tumblr-blog">
  <style>
    :host {
      display: block;
    }
    .url {
      background-color: #529ecc;
      color: white;
      text-decoration: none;
      display: block;
      text-align: center;
      padding: 30px;
      font-size: 1.2em;
      margin-top: 16px;
    }
    .url:hover {
      background-image: linear-gradient(rgba(0,0,0,.1),rgba(0,0,0,.1));
    }
    .url-container {
      border-radius: 2px;
      margin: 0 -5px;
    }
    paper-card {
      margin: 30px auto;
      display: block;
    }
    .quote {
      border-left: 3px solid #ccc;
      padding-left: 10px;
    }
    .card-actions {
      height: 40px;
      line-height: 40px;
    }
    .card-actions > a {
      color: inherit;
      float: right;
      line-height: 0;
    }
    paper-card /deep/ .header.paper-card img.paper-card {
      display: block;
      margin: 0 auto;
      width: initial;
      max-width: 100%;
      max-height: 640px;
    }
  </style>
  <template>
    <byutv-jsonp
        auto
        url="https://api.tumblr.com/v2/blog/blog.fn.lc/posts"
        handle-as="json"
        params="[[tumblrParams]]"
        on-response="handlePosts"
        debounce-duration="300"></byutv-jsonp>
    <template is="dom-repeat" items="[[posts]]">
      <template is="dom-if" if="[[!eq(item.type, 'quote')]]">
        <paper-card heading="[[item.title]]" image="[[postPhoto(item)]]">
          <template is="dom-if" if="[[item.url]]">
            <paper-material class="url-container" elevation="1">
              <a class="card-content url" href="[[item.url]]">[[item.url]]</a>
            </paper-material>
          </template>
          <div class="card-content">
            <safe-html html="[[item.description]]"></safe-html>
            <safe-html html="[[item.body]]"></safe-html>
            <safe-html html="[[item.caption]]"></safe-html>
          </div>
          <div class="card-actions">
            <span title="[[item.date]]">[[moment(item.date)]]</span>
            <a on-tap="updatePage"href="[[url(item)]]" title="Post URL">
              <paper-icon-button icon="link"></paper-icon-button>
            </a>
          </div>
        </paper-card>
      </template>
      <template is="dom-if" if="[[eq(item.type, 'quote')]]">
        <paper-card heading="Reblog">
          <div class="card-content">
            <div class="quote">
              <safe-html html="[[item.text]]"></safe-html>
            </div>
            &mdash; <safe-html html="[[item.source]]"></safe-html>
          </div>
          <div class="card-actions">
            <span title="[[item.date]]">[[moment(item.date)]]</span>
            <a href="[[item.post_url]]" title="Post URL">
              <paper-icon-button icon="link"></paper-icon-button>
            </a>
          </div>
        </paper-card>
      </template>
    </template>
  </template>
  <script>
  (function() {
    Polymer({
      is: 'tumblr-blog',

      properties: {
        posts: {
          type: Array,
        },

        post: {
          type: String,
          value: ''
        },

        tumblrParams: {
          type: String,
          computed: 'genTumblrParams(post)'
        }
      },

      genTumblrParams: function(post) {
        return {
          id: post
        };
      },

      handlePosts: function(data) {
        var resp = data.detail.response;
        this.posts = resp.posts;
        this.blog = resp.blog;
        setTimeout(function() {
          var elems = document.querySelectorAll('code');
          for (var i=0; i < elems.length; i++) {
            var elem = elems[i];
            if (!elem.classList.contains('prettyprint')) {
              elem.classList.add('prettyprint');
              elem.classList.add('linenums');
            }
          }
          window.prettyPrint();
        }, 100);
      },

      postPhoto: function(item) {
        if (!item.photos) {
          return;
        }
        return item.photos[0].original_size.url; // jshint ignore:line

      },

      eq: function(a, b) {
        return a === b;
      },

      moment: function(date) {
        return window.moment(date).fromNow();
      },

      url: function(item) {
        return '#!/blog/' + item.id + '/' + item.slug;
      },

      updatePage: function() {
        setTimeout(function() {
          window.page();
        }, 1);
      }
    });
  })();
  </script>
</dom-module>
